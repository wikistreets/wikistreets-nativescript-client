<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Leaflet</title>
    <style type="text/css">
      html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        /* prevent anything from being selected */
        -webkit-user-select:none;
        -moz-user-select: -moz-none;
        -ms-user-select:none;
        user-select:none
      }
      #map {
        width: 100%;
        height: 100%;
      }
    </style>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
      integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
      crossorigin=""
    />
    <script
      src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
      integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
      crossorigin=""
    ></script>

    <!-- connect to nativescript-webview-interface.js in NativeScript part of code -->
    <script src="./nativescript-webview-interface.js"></script>
    <script src="./decycle.js"></script><!-- for removing circular references in objects -->
    <script type="text/javascript">

      // create the map
      const southWest = L.latLng(-89.98155760646617, -180)
      const northEast = L.latLng(89.99346179538875, 180);
      const bounds = L.latLngBounds(southWest, northEast); // bounds of the world map
      const mapEl = document.getElementById("map");

      const createMap = () => {
        const map = L.map('map', {
          attributionControl: false,
          zoomControl: false,
          worldCopyJump: true,
          maxBounds: bounds, // prevent panning outside world map
          minZoom: 2
        }).setView([51.505, -0.09], 5).fitWorld()
        // map.setMinZoom( map.getBoundsZoom( map.options.maxBounds ) ) // another way to prevent zoom out of bounds
        map.on('drag', function() {
          // do not allow dragging off edge of world map
         map.panInsideBounds(bounds, { animate: false });
        })

        L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution:
            '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        }).addTo(map)

        // test marker
        // L.marker([51.5, -0.09])
        // .addTo(map)
        // .on('click', function (e) {
        //   nsWebViewInterface.emit('messageToNativeScript', 'Tapped test marker!')
        // })
        // .bindPopup('A pretty CSS popup.<br> Easily customizable.')
        // .openPopup()

        return map
      }

      // interface to NativeScript app
      window.onload = () => {

        const map = createMap() // initialize the leaflet map
        map.on('click', function (e) {
          nsWebViewInterface.emit('mapClick', {lng: e.latlng.lng, lat: e.latlng.lat})
        })

        try {

          nsWebViewInterface.emit('onload') // shoot onload message to NativeScript app
          // nsWebViewInterface.emit('takeThisMap', decycle(map)) // shoot onload message to NativeScript app

          // receive messages from NativeScript app        
          nsWebViewInterface.on('messageToWebView', function (message) {
            // shoot test message to NativeScript app
            nsWebViewInterface.emit(
              'messageToNativeScript',
              `Received message: '${message}'`
            ) 
          }) // messageToWebView

          // clear any selected text
          nsWebViewInterface.on('clearSelection', e => {
            // this is no longer necessary, thanks to CSS code that prevents selection
            // console.log('webView: clearSelection')
            if (window.getSelection) window.getSelection().removeAllRanges()
            if (document.selection) document.selection.empty()
            nsWebViewInterface.emit(
              'messageToNativeScript',
              `Cleared selection`
            ) 
          }) // clearSelection

          // set the bounding box of the map
          nsWebViewInterface.on('setBounds', bbox => {
            // expects a four value array as argument: [minX, minY, maxX, maxY]
            nsWebViewInterface.emit('messageToNativeScript', `Got bbox: ${bbox}!`)
            // console.log('webView: setBounds', bounds)
            // turfjs provides a four value array for bounds... conver to leaflet 2x two value arrays
            map.fitBounds([
              [bbox[1], bbox[0]], // [min lat, min lng]
              [bbox[3], bbox[2]], // [max lat, maxlng]
            ])
          }) // setBounds

          // set the center and zoom of the map
          nsWebViewInterface.on('setCenter', point => {
            // expects a GeoJSON Point object as argument
            const [lng, lat] = point.geometry.coordinates
            const zoom = 4
            map.setView([lat, lng], zoom)
          }) // setCenter


          // set the center and zoom of the map
          nsWebViewInterface.on('panTo', point => {
            // expects a GeoJSON Point object as argument
            const [lng, lat] = point.geometry.coordinates
            map.panTo([lat, lng])
          }) // setCenter

          // make a marker and place on map
          nsWebViewInterface.on('makeMarker', post => {
            // nsWebViewInterface.emit('messageToNativeScript', `Got a post!`)
            if (post.geometry.type === 'Point') {
              // points in leaflet have [lat,lng] format, whereas geojson in post has [lng,lat]
              const coords = [
                post.geometry.coordinates[1], 
                post.geometry.coordinates[0],
              ]
              L.marker(coords)
                .addTo(map)
                .on('click', function (e) {
                  // nsWebViewInterface.emit('messageToNativeScript', `Marker tap`)
                  nsWebViewInterface.emit('onMarkerTap', post.id)
                })
            }
          }) // makeMarker
          
        } catch (error) {
          nsWebViewInterface.emit('messageToNativeScript', `webView error: ${error}`)
        }
      }
    </script>
    <style>
      *,
      html,
      body {
        margin: 0;
        padding: 0;
      }
      .map {
        height: 100%;
      }
    </style>
  </head>
  <body>
    <div id="map" class="map"></div>
  </body>
</html>
